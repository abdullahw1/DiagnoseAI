{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-edit me-2"></i>Edit Report - Case #{{ case.id }}</h2>
                <p class="text-muted mb-0">Review and finalize the AI-generated draft report</p>
            </div>
            <div>
                <a href="{{ url_for('main.view_case', case_id=case.id) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Case
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Case Information Sidebar -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="fas fa-info-circle me-2"></i>Case Information</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Case ID:</strong> #{{ case.id }}<br>
                    <strong>Created:</strong> {{ case.created_at.strftime('%Y-%m-%d %H:%M') }}<br>
                    <strong>Status:</strong> 
                    <span class="badge bg-warning">{{ case.status|title }}</span>
                </div>
                <div class="mb-3">
                    <strong>Image:</strong><br>
                    <small class="text-muted">{{ case.image_filename }}</small>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-notes-medical me-2"></i>Clinical Notes</h6>
            </div>
            <div class="card-body">
                <div class="clinical-notes-sidebar">
                    <strong>Indication:</strong><br>
                    {{ case.indication|nl2br if case.indication else 'No indication provided.' }}
                    
                    {% if case.clinical_history %}
                    <br><br><strong>Clinical History:</strong><br>
                    {{ case.clinical_history|nl2br }}
                    {% endif %}
                    
                    {% if case.body_part %}
                    <br><br><strong>Body Part:</strong><br>
                    {{ case.body_part }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Report Editing Area -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-file-medical me-2"></i>Report Editor</h5>
                <span class="badge bg-warning">Draft - Under Review</span>
            </div>
            <div class="card-body">
                <!-- Important Notice -->
                <div class="alert alert-warning mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> Please carefully review and edit the AI-generated draft below. 
                    Ensure all medical findings are accurate before finalizing the report.
                </div>

                <!-- Report Edit Form -->
                <form method="POST" id="reportEditForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-4">
                        {{ form.report_text.label(class="form-label") }}
                        {{ form.report_text(class="form-control report-editor") }}
                        {% if form.report_text.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.report_text.errors %}
                                    <small>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group" role="group">
                            {{ form.save_draft() }}
                            {{ form.finalize_report() }}
                        </div>
                        
                        <div class="text-muted">
                            <small>
                                <i class="fas fa-save me-1"></i>
                                Changes are automatically saved as drafts
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Original AI Draft Reference -->
        {% if report.draft_text %}
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-robot me-2"></i>Original AI Draft (Reference)</h6>
            </div>
            <div class="card-body">
                <div class="original-draft">
                    {{ report.draft_text|markdown_to_html }}
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        This is the original AI-generated draft for reference. Your edits above will be saved as the final report.
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Confirmation Modal for Finalization -->
<div class="modal fade" id="finalizeModal" tabindex="-1" aria-labelledby="finalizeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="finalizeModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Finalize Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Once finalized, this report cannot be edited further.
                </div>
                <p>Are you sure you want to finalize this report? Please ensure you have reviewed all content thoroughly.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmFinalize">
                    <i class="fas fa-check me-1"></i>Yes, Finalize Report
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.clinical-notes-sidebar {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    border-left: 4px solid #0d6efd;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 0.9rem;
    max-height: 200px;
    overflow-y: auto;
}

.report-editor {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    resize: vertical;
    min-height: 400px;
}

.original-draft {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    border-left: 4px solid #6c757d;
    word-wrap: break-word;
    font-size: 0.9rem;
    max-height: 300px;
    overflow-y: auto;
    line-height: 1.6;
}

.original-draft strong {
    color: #2c3e50;
    font-weight: 600;
}

.original-draft em {
    color: #34495e;
    font-style: italic;
}

.report-section {
    margin: 1rem 0 0.5rem 0;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
}

.report-section strong {
    color: #1a365d;
    font-size: 1.05em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-group .btn {
    margin-right: 0.5rem;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

/* Character counter styling */
.char-counter {
    font-size: 0.8rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.char-counter.warning {
    color: #fd7e14;
}

.char-counter.danger {
    color: #dc3545;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reportEditForm');
    const finalizeBtn = document.querySelector('input[name="finalize_report"]');
    const saveDraftBtn = document.querySelector('input[name="save_draft"]');
    const reportTextarea = document.querySelector('textarea[name="report_text"]');
    const finalizeModal = new bootstrap.Modal(document.getElementById('finalizeModal'));
    const confirmFinalizeBtn = document.getElementById('confirmFinalize');
    
    // Add character counter
    const charCounter = document.createElement('div');
    charCounter.className = 'char-counter';
    reportTextarea.parentNode.appendChild(charCounter);
    
    function updateCharCounter() {
        const length = reportTextarea.value.length;
        const maxLength = 5000;
        charCounter.textContent = `${length}/${maxLength} characters`;
        
        if (length > maxLength * 0.9) {
            charCounter.className = 'char-counter danger';
        } else if (length > maxLength * 0.8) {
            charCounter.className = 'char-counter warning';
        } else {
            charCounter.className = 'char-counter';
        }
    }
    
    // Update character counter on input
    reportTextarea.addEventListener('input', updateCharCounter);
    updateCharCounter(); // Initial update
    
    // Handle finalize button click
    finalizeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        finalizeModal.show();
    });
    
    // Handle confirmation of finalization
    confirmFinalizeBtn.addEventListener('click', function() {
        // Create a hidden input to indicate finalization
        const finalizeInput = document.createElement('input');
        finalizeInput.type = 'hidden';
        finalizeInput.name = 'finalize_report';
        finalizeInput.value = 'Finalize Report';
        form.appendChild(finalizeInput);
        
        // Submit the form
        form.submit();
    });
    
    // Auto-save functionality (optional enhancement)
    let autoSaveTimeout;
    reportTextarea.addEventListener('input', function() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(function() {
            // Could implement auto-save here
            console.log('Auto-save triggered');
        }, 30000); // Auto-save after 30 seconds of inactivity
    });
});
</script>
{% endblock %}